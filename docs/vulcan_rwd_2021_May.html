---

title: Transforming FHIR resources


keywords: fastai
sidebar: home_sidebar

summary: "Convert FHIR resources into other types of FHIR resources or flatten into a table."
description: "Convert FHIR resources into other types of FHIR resources or flatten into a table."
nb_path: "vulcan_rwd_2021_May.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: vulcan_rwd_2021_May.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><a href="https://colab.research.google.com/github/pete88b/smart-on-fhir-client-py-demo/blob/main/10_transform.ipynb"><img src="https://colab.research.google.com/assets/colab-badge.svg" alt="Open In Colab"></a></p>
<p>Please note:</p>
<ul>
<li>Data on the FHIR server might change (resources might disapear making the IDs invalid, resources might be updated and no longer pass validation ...)<ul>
<li>you can search for and modify resources through the <a href="http://hapi.fhir.org/baseR4">HAPI FHIR swagger UI</a></li>
</ul>
</li>
<li>This is not meant to be a fully robust solution - we make a few simplifications (like only looking at the 1st item in a list when pulling attributes) - to avoid getting lost in the details ...</li>
</ul>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">fhirclient</span> <span class="kn">import</span> <span class="n">client</span>
<span class="kn">from</span> <span class="nn">fhirclient.models.annotation</span> <span class="kn">import</span> <span class="n">Annotation</span>
<span class="kn">from</span> <span class="nn">fhirclient.models.dosage</span> <span class="kn">import</span> <span class="n">Dosage</span>
<span class="kn">from</span> <span class="nn">fhirclient.models.fhirreference</span> <span class="kn">import</span> <span class="n">FHIRReference</span>
<span class="kn">from</span> <span class="nn">fhirclient.models.medication</span> <span class="kn">import</span> <span class="n">Medication</span>
<span class="kn">from</span> <span class="nn">fhirclient.models.medicationadministration</span> <span class="kn">import</span> <span class="n">MedicationAdministration</span>
<span class="kn">from</span> <span class="nn">fhirclient.models.medicationdispense</span> <span class="kn">import</span> <span class="n">MedicationDispense</span>
<span class="kn">from</span> <span class="nn">fhirclient.models.medicationrequest</span> <span class="kn">import</span> <span class="n">MedicationRequest</span>
<span class="kn">from</span> <span class="nn">fhirclient.models.medicationstatement</span> <span class="kn">import</span> <span class="n">MedicationStatement</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">resource_to_string</span><span class="p">(</span><span class="n">resource</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">resource</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span> <span class="k">return</span> <span class="p">[</span><span class="n">resource_to_string</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">indent</span><span class="p">,</span><span class="n">length</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">resource</span><span class="p">]</span>
    <span class="n">s</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">resource</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">as_json</span><span class="p">(),</span> <span class="n">indent</span><span class="o">=</span><span class="n">indent</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">s</span><span class="p">[:</span><span class="n">length</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span><span class="si">}</span><span class="s1"> ...&#39;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">&gt;</span><span class="n">length</span> <span class="k">else</span> <span class="n">s</span>

<span class="k">def</span> <span class="nf">print_resource</span><span class="p">(</span><span class="n">resource</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">90</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">resource</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span> <span class="k">return</span> <span class="p">[</span><span class="n">print_resource</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">indent</span><span class="p">,</span><span class="n">length</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">resource</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">resource_to_string</span><span class="p">(</span><span class="n">resource</span><span class="p">,</span> <span class="n">indent</span><span class="p">,</span> <span class="n">length</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">settings</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;app_id&#39;</span><span class="p">:</span> <span class="s1">&#39;my_web_app&#39;</span><span class="p">,</span>
    <span class="s1">&#39;api_base&#39;</span><span class="p">:</span> <span class="s1">&#39;http://hapi.fhir.org/baseR4&#39;</span>
<span class="p">}</span>
<span class="n">smart</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">FHIRClient</span><span class="p">(</span><span class="n">settings</span><span class="o">=</span><span class="n">settings</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><code>pull_attr</code> allows us to pull values out of a resource using "attribute paths" that can</p>
<ul>
<li>contain <code>.</code>s for nested attributes and </li>
<li>multiple paths separated by <code>OR</code></li>
</ul>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">noop</span><span class="p">(</span><span class="n">r</span><span class="p">):</span> <span class="k">return</span> <span class="n">r</span>
<span class="k">def</span> <span class="nf">default_format</span><span class="p">(</span><span class="n">r</span><span class="p">):</span> <span class="k">return</span> <span class="n">r</span><span class="o">.</span><span class="n">as_json</span><span class="p">()</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="s1">&#39;as_json&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="n">r</span>
<span class="k">def</span> <span class="nf">pull_attr</span><span class="p">(</span><span class="n">resouce</span><span class="p">,</span><span class="n">attr_path</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="n">default_format</span><span class="p">):</span>
    <span class="s2">&quot;Pull a value from `resource` if we can find the attribute specified&quot;</span>
    <span class="k">for</span> <span class="n">_attr_path</span> <span class="ow">in</span> <span class="n">attr_path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; OR &#39;</span><span class="p">):</span>
        <span class="n">r</span><span class="p">,</span><span class="n">found</span><span class="o">=</span><span class="n">resouce</span><span class="p">,</span><span class="kc">True</span>
        <span class="k">for</span> <span class="n">_attr</span> <span class="ow">in</span> <span class="n">_attr_path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">_attr</span><span class="p">):</span> 
                <span class="n">found</span><span class="o">=</span><span class="kc">False</span><span class="p">;</span> <span class="k">break</span>
            <span class="n">r</span><span class="o">=</span><span class="nb">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">_attr</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="n">r</span><span class="p">:</span> <span class="n">r</span><span class="o">=</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">found</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">fmt</span><span class="p">(</span><span class="n">_r</span><span class="p">)</span> <span class="k">for</span> <span class="n">_r</span> <span class="ow">in</span> <span class="n">r</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="n">fmt</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">medication_request</span><span class="o">=</span><span class="n">MedicationRequest</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s1">&#39;2087020&#39;</span><span class="p">,</span> <span class="n">smart</span><span class="o">.</span><span class="n">server</span><span class="p">)</span>
<span class="n">print_resource</span><span class="p">(</span><span class="n">medication_request</span><span class="p">)</span>
<span class="k">assert</span> <span class="s1">&#39;2087020&#39;</span><span class="o">==</span><span class="n">pull_attr</span><span class="p">(</span><span class="n">medication_request</span><span class="p">,</span><span class="s1">&#39;id&#39;</span><span class="p">)</span>
<span class="k">assert</span> <span class="s1">&#39;2021-05-11T12:51:16.534+00:00&#39;</span><span class="o">==</span><span class="n">pull_attr</span><span class="p">(</span><span class="n">medication_request</span><span class="p">,</span><span class="s1">&#39;meta.lastUpdated&#39;</span><span class="p">)</span>
<span class="k">assert</span> <span class="s1">&#39;2087020&#39;</span><span class="o">==</span><span class="n">pull_attr</span><span class="p">(</span><span class="n">medication_request</span><span class="p">,</span><span class="s1">&#39;id OR meta.lastUpdated&#39;</span><span class="p">)</span>
<span class="k">assert</span> <span class="s1">&#39;2087020&#39;</span><span class="o">==</span><span class="n">pull_attr</span><span class="p">(</span><span class="n">medication_request</span><span class="p">,</span><span class="s1">&#39;doesNotExist OR doesNotExist2 OR id&#39;</span><span class="p">)</span>
<span class="k">assert</span> <span class="s1">&#39;2021-05-11T12:51:16.534+00:00&#39;</span><span class="o">==</span><span class="n">pull_attr</span><span class="p">(</span><span class="n">medication_request</span><span class="p">,</span><span class="s1">&#39;doesNotExist OR meta.lastUpdated&#39;</span><span class="p">)</span>
<span class="k">assert</span> <span class="s1">&#39;2021-05-11T12:51:16.534+00:00&#39;</span><span class="o">==</span><span class="n">pull_attr</span><span class="p">(</span><span class="n">medication_request</span><span class="p">,</span><span class="s1">&#39;meta.lastUpdated OR id&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>MedicationRequest {&#34;id&#34;: &#34;2087020&#34;, &#34;meta&#34;: {&#34;lastUpdated&#34;: &#34;2021-05-11T12:51:16.534+0 ...
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>When an attribute is a <code>list</code> (like "coding" below),</p>

<pre><code>  "medicationCodeableConcept": {
    "coding": [
      {
        "code": "630208",
        "display": "Albuterol 0.83 MG/ML Inhalant Solution",
        "system": "http://www.nlm.nih.gov/research/umls/rxnorm"
      },
      {
        "system": "urn:oid:"
      }
    ],
    "text": "Albuterol Sulfate (Albuterol Sulfate 2.5MG/3ML) 0.083 % Neb Neb, 2.5 Mg Neb"
  },</code></pre>
<p>we want to use the 1st item in the list &darr;</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">pull_attr</span><span class="p">(</span><span class="n">medication_request</span><span class="p">,</span><span class="s1">&#39;medicationCodeableConcept.coding.code&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>&#39;630208&#39;</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Map-medication-request-to-medication-statement">Map medication request to medication statement<a class="anchor-link" href="#Map-medication-request-to-medication-statement"> </a></h2><p>The keys of <code>medication_request_to_medication_statement</code> are medication statement attributes, its values are medication request attributes.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">medication_request_to_medication_statement</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
    <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="n">meta</span><span class="o">=</span><span class="s1">&#39;meta&#39;</span><span class="p">,</span> <span class="n">implicitRules</span><span class="o">=</span><span class="s1">&#39;implicitRules&#39;</span><span class="p">,</span> <span class="n">language</span><span class="o">=</span><span class="s1">&#39;language&#39;</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s1">&#39;text&#39;</span><span class="p">,</span> <span class="n">contained</span><span class="o">=</span><span class="s1">&#39;contained&#39;</span><span class="p">,</span> <span class="n">extension</span><span class="o">=</span><span class="s1">&#39;extension&#39;</span><span class="p">,</span> <span class="n">modifierExtension</span><span class="o">=</span><span class="s1">&#39;modifierExtension&#39;</span><span class="p">,</span>
    <span class="n">identifier</span><span class="o">=</span><span class="s1">&#39;identifier&#39;</span><span class="p">,</span>
<span class="c1">#     basedOn=&#39;id&#39;, #TODO: make this a reference</span>
    <span class="n">partOf</span><span class="o">=</span><span class="s1">&#39;partOf&#39;</span><span class="p">,</span>
    <span class="n">status</span><span class="o">=</span><span class="s1">&#39;status&#39;</span><span class="p">,</span>
    <span class="n">statusReason</span><span class="o">=</span><span class="s1">&#39;statusReason&#39;</span><span class="p">,</span>
    <span class="n">category</span><span class="o">=</span><span class="s1">&#39;category&#39;</span><span class="p">,</span>
    <span class="n">medicationCodeableConcept</span><span class="o">=</span><span class="s1">&#39;medicationCodeableConcept&#39;</span><span class="p">,</span>
    <span class="n">medicationReference</span><span class="o">=</span><span class="s1">&#39;medicationReference&#39;</span><span class="p">,</span>
    <span class="n">subject</span><span class="o">=</span><span class="s1">&#39;subject&#39;</span><span class="p">,</span>
    <span class="n">context</span><span class="o">=</span><span class="s1">&#39;encounter&#39;</span><span class="p">,</span>
<span class="c1">#     effectiveDateTime                         # might be better to leave this blank as we have dosage</span>
    <span class="n">effectivePeriod</span><span class="o">=</span><span class="s1">&#39;dosageInstruction.timing&#39;</span><span class="p">,</span> <span class="c1"># might be better to leave this blank as we have dosage</span>
    <span class="n">dateAsserted</span><span class="o">=</span><span class="s1">&#39;authoredOn&#39;</span><span class="p">,</span>
    <span class="n">informationSource</span><span class="o">=</span><span class="s1">&#39;requester&#39;</span><span class="p">,</span>
<span class="c1">#     derivedFrom=&#39;id&#39;, #TODO: make this a reference</span>
    <span class="n">reasonCode</span><span class="o">=</span><span class="s1">&#39;reasonCode&#39;</span><span class="p">,</span>
    <span class="n">reasonReference</span><span class="o">=</span><span class="s1">&#39;reasonReference&#39;</span><span class="p">,</span>
    <span class="n">note</span><span class="o">=</span><span class="s1">&#39;note&#39;</span><span class="p">,</span>
    <span class="n">dosage</span><span class="o">=</span><span class="s1">&#39;dosageInstruction&#39;</span>
<span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Map-medication-dispense-to-medication-statement">Map medication dispense to medication statement<a class="anchor-link" href="#Map-medication-dispense-to-medication-statement"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">medication_dispense_to_medication_statement</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
    <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="n">meta</span><span class="o">=</span><span class="s1">&#39;meta&#39;</span><span class="p">,</span> <span class="n">implicitRules</span><span class="o">=</span><span class="s1">&#39;implicitRules&#39;</span><span class="p">,</span> <span class="n">language</span><span class="o">=</span><span class="s1">&#39;language&#39;</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s1">&#39;text&#39;</span><span class="p">,</span> <span class="n">contained</span><span class="o">=</span><span class="s1">&#39;contained&#39;</span><span class="p">,</span> <span class="n">extension</span><span class="o">=</span><span class="s1">&#39;extension&#39;</span><span class="p">,</span> <span class="n">modifierExtension</span><span class="o">=</span><span class="s1">&#39;modifierExtension&#39;</span><span class="p">,</span>
    <span class="n">identifier</span><span class="o">=</span><span class="s1">&#39;identifier&#39;</span><span class="p">,</span>
    <span class="n">basedOn</span><span class="o">=</span><span class="s1">&#39;authorizingPrescription&#39;</span><span class="p">,</span>
    <span class="n">partOf</span><span class="o">=</span><span class="s1">&#39;partOf&#39;</span><span class="p">,</span>
    <span class="n">status</span><span class="o">=</span><span class="s1">&#39;status&#39;</span><span class="p">,</span>
    <span class="n">statusReason</span><span class="o">=</span><span class="s1">&#39;statusReason&#39;</span><span class="p">,</span>
    <span class="n">category</span><span class="o">=</span><span class="s1">&#39;category&#39;</span><span class="p">,</span>
    <span class="n">medicationCodeableConcept</span><span class="o">=</span><span class="s1">&#39;medicationCodeableConcept&#39;</span><span class="p">,</span>
    <span class="n">medicationReference</span><span class="o">=</span><span class="s1">&#39;medicationReference&#39;</span><span class="p">,</span>
    <span class="n">subject</span><span class="o">=</span><span class="s1">&#39;subject&#39;</span><span class="p">,</span>
    <span class="n">context</span><span class="o">=</span><span class="s1">&#39;context&#39;</span><span class="p">,</span>
<span class="c1">#     effectiveDateTime                         # might be better to leave this blank as we have dosage</span>
    <span class="n">effectivePeriod</span><span class="o">=</span><span class="s1">&#39;dosageInstruction.timing&#39;</span><span class="p">,</span> <span class="c1"># might be better to leave this blank as we have dosage</span>
    <span class="c1">#     dateAsserted # pull from event history?</span>
    <span class="n">informationSource</span><span class="o">=</span><span class="s1">&#39;performer&#39;</span><span class="p">,</span>
<span class="c1">#     derivedFrom=&#39;id&#39;, #TODO: make this a reference</span>
<span class="c1">#     reasonCode</span>
<span class="c1">#     reasonReference</span>
    <span class="n">note</span><span class="o">=</span><span class="s1">&#39;note&#39;</span><span class="p">,</span>
    <span class="n">dosage</span><span class="o">=</span><span class="s1">&#39;dosageInstruction&#39;</span>
<span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Map-medication-administration-dosage-to-dosage">Map medication administration dosage to dosage<a class="anchor-link" href="#Map-medication-administration-dosage-to-dosage"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">medication_administration_dose_to_dose</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
    <span class="n">text</span><span class="o">=</span><span class="s1">&#39;text&#39;</span><span class="p">,</span>
    <span class="n">site</span><span class="o">=</span><span class="s1">&#39;site&#39;</span><span class="p">,</span>
    <span class="n">route</span><span class="o">=</span><span class="s1">&#39;route&#39;</span><span class="p">,</span>
    <span class="n">method</span><span class="o">=</span><span class="s1">&#39;method&#39;</span><span class="p">,</span>
    <span class="n">doseQuantity</span><span class="o">=</span><span class="s1">&#39;dose&#39;</span><span class="p">,</span>
    <span class="n">rateRatio</span><span class="o">=</span><span class="s1">&#39;rateRatio&#39;</span><span class="p">,</span>
    <span class="n">rateQuantity</span><span class="o">=</span><span class="s1">&#39;rateQuantity&#39;</span>
<span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Map-medication-administration-to-medication-statement">Map medication administration to medication statement<a class="anchor-link" href="#Map-medication-administration-to-medication-statement"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">medication_administration_to_medication_statement</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
    <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="n">meta</span><span class="o">=</span><span class="s1">&#39;meta&#39;</span><span class="p">,</span> <span class="n">implicitRules</span><span class="o">=</span><span class="s1">&#39;implicitRules&#39;</span><span class="p">,</span> <span class="n">language</span><span class="o">=</span><span class="s1">&#39;language&#39;</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s1">&#39;text&#39;</span><span class="p">,</span> <span class="n">contained</span><span class="o">=</span><span class="s1">&#39;contained&#39;</span><span class="p">,</span> <span class="n">extension</span><span class="o">=</span><span class="s1">&#39;extension&#39;</span><span class="p">,</span> <span class="n">modifierExtension</span><span class="o">=</span><span class="s1">&#39;modifierExtension&#39;</span><span class="p">,</span>
    <span class="n">identifier</span><span class="o">=</span><span class="s1">&#39;identifier&#39;</span><span class="p">,</span>
    <span class="n">basedOn</span><span class="o">=</span><span class="s1">&#39;request&#39;</span><span class="p">,</span>
    <span class="n">partOf</span><span class="o">=</span><span class="s1">&#39;partOf&#39;</span><span class="p">,</span>
    <span class="n">status</span><span class="o">=</span><span class="s1">&#39;status&#39;</span><span class="p">,</span>
    <span class="n">statusReason</span><span class="o">=</span><span class="s1">&#39;statusReason&#39;</span><span class="p">,</span>
    <span class="n">category</span><span class="o">=</span><span class="s1">&#39;category&#39;</span><span class="p">,</span>
    <span class="n">medicationCodeableConcept</span><span class="o">=</span><span class="s1">&#39;medicationCodeableConcept&#39;</span><span class="p">,</span>
    <span class="n">medicationReference</span><span class="o">=</span><span class="s1">&#39;medicationReference&#39;</span><span class="p">,</span>
    <span class="n">subject</span><span class="o">=</span><span class="s1">&#39;subject&#39;</span><span class="p">,</span>
    <span class="n">context</span><span class="o">=</span><span class="s1">&#39;context&#39;</span><span class="p">,</span>
    <span class="n">effectiveDateTime</span><span class="o">=</span><span class="s1">&#39;effectiveDateTime&#39;</span><span class="p">,</span>
    <span class="n">effectivePeriod</span><span class="o">=</span><span class="s1">&#39;effectivePeriod&#39;</span><span class="p">,</span>
<span class="c1">#     dateAsserted # pull from event history?</span>
    <span class="n">informationSource</span><span class="o">=</span><span class="s1">&#39;performer&#39;</span><span class="p">,</span>
<span class="c1">#     derivedFrom=&#39;id&#39;, #TODO: make this a reference</span>
<span class="c1">#     reasonCode</span>
    <span class="n">reasonReference</span><span class="o">=</span><span class="s1">&#39;reasonReference&#39;</span><span class="p">,</span>
    <span class="n">note</span><span class="o">=</span><span class="s1">&#39;note&#39;</span><span class="p">,</span>
<span class="c1">#     dosage=&#39;dosage&#39; # need to map MedicationAdministrationDosage to Dosage</span>
<span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">transform</span><span class="p">(</span><span class="n">resource</span><span class="p">,</span><span class="n">new_type</span><span class="p">,</span><span class="n">mapping</span><span class="p">):</span>
    <span class="s2">&quot;Pull data from `resource` to create an instance of `new_type` using `mapping`&quot;</span>
    <span class="n">result</span><span class="o">=</span><span class="n">new_type</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">mapping</span><span class="p">:</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">result</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">pull_attr</span><span class="p">(</span><span class="n">resource</span><span class="p">,</span><span class="n">mapping</span><span class="p">[</span><span class="n">k</span><span class="p">],</span><span class="n">noop</span><span class="p">))</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">result</span><span class="p">,</span><span class="s1">&#39;note&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span><span class="o">.</span><span class="n">note</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">note</span><span class="o">=</span><span class="p">[</span><span class="n">Annotation</span><span class="p">()]</span>
        <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">note</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">note</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="o">+=</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Created by py transform&#39;</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">note</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="o">=</span><span class="s1">&#39;Created by py transform&#39;</span> <span class="c1"># TODO: timestamp</span>
    <span class="k">return</span> <span class="n">result</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="transform-a-medication-request-into-a-medication-statement">transform a medication request into a medication statement<a class="anchor-link" href="#transform-a-medication-request-into-a-medication-statement"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">tfm_request</span><span class="o">=</span><span class="n">transform</span><span class="p">(</span><span class="n">medication_request</span><span class="p">,</span><span class="n">MedicationStatement</span><span class="p">,</span><span class="n">medication_request_to_medication_statement</span><span class="p">)</span>
<span class="n">ref</span><span class="o">=</span><span class="n">FHIRReference</span><span class="p">()</span>
<span class="n">ref</span><span class="o">.</span><span class="n">reference</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;MedicationRequest/</span><span class="si">{</span><span class="n">medication_request</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s1">&#39;</span>
<span class="n">tfm_request</span><span class="o">.</span><span class="n">derivedFrom</span><span class="o">=</span><span class="p">[</span><span class="n">ref</span><span class="p">]</span>
<span class="n">tfm_request</span><span class="o">.</span><span class="n">basedOn</span><span class="o">=</span><span class="p">[</span><span class="n">ref</span><span class="p">]</span>
<span class="n">tfm_request</span><span class="o">.</span><span class="n">identifier</span><span class="o">=</span><span class="p">[</span><span class="n">tfm_request</span><span class="o">.</span><span class="n">identifier</span><span class="p">]</span>
<span class="c1"># print_resource(tfm_request)</span>
<span class="n">print_resource</span><span class="p">(</span><span class="n">tfm_request</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">9999</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>MedicationStatement {
  &#34;id&#34;: &#34;2087020&#34;,
  &#34;meta&#34;: {
    &#34;lastUpdated&#34;: &#34;2021-05-11T12:51:16.534+00:00&#34;,
    &#34;source&#34;: &#34;#bl4SVWpGAkdLvNRm&#34;,
    &#34;versionId&#34;: &#34;1&#34;
  },
  &#34;basedOn&#34;: [
    {
      &#34;reference&#34;: &#34;MedicationRequest/2087020&#34;
    }
  ],
  &#34;derivedFrom&#34;: [
    {
      &#34;reference&#34;: &#34;MedicationRequest/2087020&#34;
    }
  ],
  &#34;identifier&#34;: [
    {
      &#34;system&#34;: &#34;https://kpininja.com/identifier&#34;,
      &#34;value&#34;: &#34;5119e94c-0a16-45b8-a555-0596d6cdc852&#34;
    }
  ],
  &#34;informationSource&#34;: {
    &#34;reference&#34;: &#34;Practitioner/2087019&#34;
  },
  &#34;medicationCodeableConcept&#34;: {
    &#34;coding&#34;: [
      {
        &#34;code&#34;: &#34;630208&#34;,
        &#34;display&#34;: &#34;Albuterol 0.83 MG/ML Inhalant Solution&#34;,
        &#34;system&#34;: &#34;http://www.nlm.nih.gov/research/umls/rxnorm&#34;
      },
      {
        &#34;system&#34;: &#34;urn:oid:&#34;
      }
    ],
    &#34;text&#34;: &#34;Albuterol Sulfate (Albuterol Sulfate 2.5MG/3ML) 0.083 % Neb Neb, 2.5 Mg Neb&#34;
  },
  &#34;note&#34;: [
    {
      &#34;text&#34;: &#34;Created by py transform&#34;
    }
  ],
  &#34;status&#34;: &#34;unknown&#34;,
  &#34;subject&#34;: {
    &#34;reference&#34;: &#34;Patient/1995674&#34;
  },
  &#34;resourceType&#34;: &#34;MedicationStatement&#34;
}
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="transform-a-medication-dispense-into-a-medication-statement">transform a medication dispense into a medication statement<a class="anchor-link" href="#transform-a-medication-dispense-into-a-medication-statement"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">medication_dispense</span><span class="o">=</span><span class="n">MedicationDispense</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s1">&#39;2040745&#39;</span><span class="p">,</span> <span class="n">smart</span><span class="o">.</span><span class="n">server</span><span class="p">)</span>
<span class="n">tfm_dispense</span><span class="o">=</span><span class="n">transform</span><span class="p">(</span><span class="n">medication_dispense</span><span class="p">,</span> <span class="n">MedicationStatement</span><span class="p">,</span> <span class="n">medication_dispense_to_medication_statement</span><span class="p">)</span>
<span class="n">ref</span><span class="o">=</span><span class="n">FHIRReference</span><span class="p">()</span>
<span class="n">ref</span><span class="o">.</span><span class="n">reference</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;MedicationDispense/</span><span class="si">{</span><span class="n">medication_dispense</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s1">&#39;</span>
<span class="n">tfm_dispense</span><span class="o">.</span><span class="n">derivedFrom</span><span class="o">=</span><span class="p">[</span><span class="n">ref</span><span class="p">]</span>
<span class="n">tfm_dispense</span><span class="o">.</span><span class="n">identifier</span><span class="o">=</span><span class="p">[</span><span class="n">tfm_dispense</span><span class="o">.</span><span class="n">identifier</span><span class="p">]</span>
<span class="n">print_resource</span><span class="p">(</span><span class="n">tfm_dispense</span><span class="p">)</span>
<span class="c1"># print_resource(tfm_dispense,2,9999)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>MedicationStatement {&#34;id&#34;: &#34;2040745&#34;, &#34;meta&#34;: {&#34;lastUpdated&#34;: &#34;2021-05-10T11:56:56.228 ...
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="transform-a-medication-administration-into-a-medication-statement">transform a medication administration into a medication statement<a class="anchor-link" href="#transform-a-medication-administration-into-a-medication-statement"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">medication_administration</span><span class="o">=</span><span class="n">MedicationAdministration</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s1">&#39;2086901&#39;</span><span class="p">,</span> <span class="n">smart</span><span class="o">.</span><span class="n">server</span><span class="p">)</span>
<span class="n">tfm_administration</span><span class="o">=</span><span class="n">transform</span><span class="p">(</span><span class="n">medication_administration</span><span class="p">,</span> <span class="n">MedicationStatement</span><span class="p">,</span> <span class="n">medication_administration_to_medication_statement</span><span class="p">)</span>
<span class="n">tfm_administration</span><span class="o">.</span><span class="n">dosage</span><span class="o">=</span><span class="p">[</span><span class="n">transform</span><span class="p">(</span><span class="n">medication_administration</span><span class="o">.</span><span class="n">dosage</span><span class="p">,</span><span class="n">Dosage</span><span class="p">,</span><span class="n">medication_administration_dose_to_dose</span><span class="p">)]</span>
<span class="n">ref</span><span class="o">=</span><span class="n">FHIRReference</span><span class="p">()</span>
<span class="n">ref</span><span class="o">.</span><span class="n">reference</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;MedicationAdministration/</span><span class="si">{</span><span class="n">medication_administration</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s1">&#39;</span>
<span class="n">tfm_administration</span><span class="o">.</span><span class="n">derivedFrom</span><span class="o">=</span><span class="p">[</span><span class="n">ref</span><span class="p">]</span>
<span class="n">tfm_administration</span><span class="o">.</span><span class="n">identifier</span><span class="o">=</span><span class="p">[</span><span class="n">tfm_administration</span><span class="o">.</span><span class="n">identifier</span><span class="p">]</span>
<span class="n">print_resource</span><span class="p">(</span><span class="n">tfm_administration</span><span class="p">)</span>
<span class="c1"># print_resource(tfm_administration,2,9999)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>MedicationStatement {&#34;id&#34;: &#34;2086901&#34;, &#34;meta&#34;: {&#34;lastUpdated&#34;: &#34;2021-05-18T17:03:24.627 ...
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">medication_statement</span><span class="o">=</span><span class="n">MedicationStatement</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">2086902</span><span class="p">,</span> <span class="n">smart</span><span class="o">.</span><span class="n">server</span><span class="p">)</span>
<span class="n">print_resource</span><span class="p">(</span><span class="n">medication_statement</span><span class="p">)</span>
<span class="c1"># print_resource(medication_statement,2,9999)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>MedicationStatement {&#34;id&#34;: &#34;2086902&#34;, &#34;meta&#34;: {&#34;lastUpdated&#34;: &#34;2021-05-12T05:13:47.341 ...
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>This bit &darr; uses the mapping dictionaries we created earlier to build a list of "attribute paths" that we can use to create a data frame of all 4 mediction types</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">attr_paths</span><span class="o">=</span><span class="p">[]</span>
<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">([</span><span class="o">*</span><span class="n">medication_request_to_medication_statement</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span>
              <span class="o">*</span><span class="n">medication_dispense_to_medication_statement</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span>
              <span class="o">*</span><span class="n">medication_administration_to_medication_statement</span><span class="o">.</span><span class="n">keys</span><span class="p">()]):</span>
    <span class="n">attr_paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span>
        <span class="n">medication_request_to_medication_statement</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="kc">None</span><span class="p">),</span>
        <span class="n">medication_dispense_to_medication_statement</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="kc">None</span><span class="p">),</span>
        <span class="n">medication_administration_to_medication_statement</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>
    <span class="p">]))</span>
<span class="k">def</span> <span class="nf">set_to_attr_path</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="k">return</span> <span class="s1">&#39; OR &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">s</span> <span class="k">if</span> <span class="n">a</span><span class="p">])</span>
<span class="n">attr_paths</span><span class="o">=</span><span class="p">[</span><span class="n">set_to_attr_path</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">attr_paths</span><span class="p">]</span>
<span class="n">attr_paths</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>[&#39;language&#39;,
 &#39;request OR authorizingPrescription&#39;,
 &#39;authoredOn&#39;,
 &#39;id&#39;,
 &#39;text&#39;,
 &#39;contained&#39;,
 &#39;meta&#39;,
 &#39;status&#39;,
 &#39;subject&#39;,
 &#39;medicationReference&#39;,
 &#39;reasonCode&#39;,
 &#39;effectiveDateTime&#39;,
 &#39;identifier&#39;,
 &#39;partOf&#39;,
 &#39;reasonReference&#39;,
 &#39;extension&#39;,
 &#39;modifierExtension&#39;,
 &#39;note&#39;,
 &#39;implicitRules&#39;,
 &#39;dosageInstruction&#39;,
 &#39;context OR encounter&#39;,
 &#39;performer OR requester&#39;,
 &#39;medicationCodeableConcept&#39;,
 &#39;dosageInstruction.timing OR effectivePeriod&#39;,
 &#39;statusReason&#39;,
 &#39;category&#39;]</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">to_df</span><span class="p">(</span><span class="n">resources</span><span class="p">,</span><span class="n">attr_paths</span><span class="p">):</span>
    <span class="s2">&quot;Create a data frame of `resources` - one row per resource - one column per attribute path&quot;</span>
    <span class="n">d</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">resourceType</span><span class="o">=</span><span class="p">[</span><span class="n">r</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">resources</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">attr_path</span> <span class="ow">in</span> <span class="n">attr_paths</span><span class="p">:</span>
        <span class="n">d</span><span class="p">[</span><span class="n">attr_path</span><span class="p">]</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">resources</span><span class="p">:</span>
            <span class="n">d</span><span class="p">[</span><span class="n">attr_path</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pull_attr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">attr_path</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>create a data frame of all 4 mediction types</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df</span><span class="o">=</span><span class="n">to_df</span><span class="p">([</span><span class="n">medication_request</span><span class="p">,</span><span class="n">medication_dispense</span><span class="p">,</span><span class="n">medication_administration</span><span class="p">,</span><span class="n">medication_statement</span><span class="p">],</span><span class="n">attr_paths</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s1">&#39;_tmp_a.csv&#39;</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="c1"># In colab, use the &quot;Files&quot; sidebar to open or download this file</span>
<span class="n">df</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>resourceType</th>
      <th>language</th>
      <th>request OR authorizingPrescription</th>
      <th>authoredOn</th>
      <th>id</th>
      <th>text</th>
      <th>contained</th>
      <th>meta</th>
      <th>status</th>
      <th>subject</th>
      <th>...</th>
      <th>modifierExtension</th>
      <th>note</th>
      <th>implicitRules</th>
      <th>dosageInstruction</th>
      <th>context OR encounter</th>
      <th>performer OR requester</th>
      <th>medicationCodeableConcept</th>
      <th>dosageInstruction.timing OR effectivePeriod</th>
      <th>statusReason</th>
      <th>category</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>MedicationRequest</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>2087020</td>
      <td>None</td>
      <td>None</td>
      <td>{'lastUpdated': '2021-05-11T12:51:16.534+00:00...</td>
      <td>unknown</td>
      <td>{'reference': 'Patient/1995674'}</td>
      <td>...</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>{'coding': [{'code': '630208', 'display': 'Alb...</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
    </tr>
    <tr>
      <th>1</th>
      <td>MedicationDispense</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>2040745</td>
      <td>None</td>
      <td>None</td>
      <td>{'lastUpdated': '2021-05-10T11:56:56.228+00:00...</td>
      <td>completed</td>
      <td>{'reference': 'Patient/1993103'}</td>
      <td>...</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>{'coding': [{'system': 'urn:oid:'}, {'system':...</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
    </tr>
    <tr>
      <th>2</th>
      <td>MedicationAdministration</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>2086901</td>
      <td>None</td>
      <td>None</td>
      <td>{'lastUpdated': '2021-05-18T17:03:24.627+00:00...</td>
      <td>completed</td>
      <td>{'reference': 'Patient/1995674'}</td>
      <td>...</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>{'coding': [{'code': '745752', 'display': 'ALB...</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
    </tr>
    <tr>
      <th>3</th>
      <td>MedicationStatement</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>2086902</td>
      <td>None</td>
      <td>None</td>
      <td>{'lastUpdated': '2021-05-12T05:13:47.341+00:00...</td>
      <td>completed</td>
      <td>{'reference': 'Patient/1995674'}</td>
      <td>...</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>{'coding': [{'code': '745752', 'display': 'ALB...</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
    </tr>
  </tbody>
</table>
<p>4 rows  27 columns</p>
</div>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>create a dataframe of the same 4 resources - after transforming them to medication statements</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">statement_attr_paths</span><span class="o">=</span><span class="p">[</span>
    <span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;meta&#39;</span><span class="p">,</span> <span class="s1">&#39;implicitRules&#39;</span><span class="p">,</span>  <span class="s1">&#39;text&#39;</span><span class="p">,</span> <span class="s1">&#39;contained&#39;</span><span class="p">,</span> <span class="s1">&#39;extension&#39;</span><span class="p">,</span>
    <span class="s1">&#39;modifierExtension&#39;</span><span class="p">,</span> <span class="s1">&#39;identifier&#39;</span><span class="p">,</span> <span class="s1">&#39;basedOn&#39;</span><span class="p">,</span> <span class="s1">&#39;partOf&#39;</span><span class="p">,</span> <span class="s1">&#39;status&#39;</span><span class="p">,</span>
    <span class="s1">&#39;statusReason&#39;</span><span class="p">,</span> <span class="s1">&#39;category&#39;</span><span class="p">,</span> <span class="s1">&#39;medicationCodeableConcept&#39;</span><span class="p">,</span> <span class="s1">&#39;medicationReference&#39;</span><span class="p">,</span>
    <span class="s1">&#39;subject&#39;</span><span class="p">,</span> <span class="s1">&#39;context&#39;</span><span class="p">,</span> <span class="s1">&#39;effectiveDateTime&#39;</span><span class="p">,</span> <span class="s1">&#39;effectivePeriod&#39;</span><span class="p">,</span> <span class="s1">&#39;dateAsserted&#39;</span><span class="p">,</span>
    <span class="s1">&#39;informationSource&#39;</span><span class="p">,</span> <span class="s1">&#39;derivedFrom&#39;</span><span class="p">,</span> <span class="s1">&#39;reasonCode&#39;</span><span class="p">,</span> <span class="s1">&#39;reasonReference&#39;</span><span class="p">,</span> <span class="s1">&#39;note&#39;</span><span class="p">,</span> <span class="s1">&#39;dosage&#39;</span><span class="p">]</span>
<span class="n">df</span><span class="o">=</span><span class="n">to_df</span><span class="p">([</span><span class="n">tfm_request</span><span class="p">,</span><span class="n">tfm_dispense</span><span class="p">,</span><span class="n">tfm_administration</span><span class="p">,</span><span class="n">medication_statement</span><span class="p">],</span><span class="n">statement_attr_paths</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s1">&#39;_tmp_b.csv&#39;</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">df</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>resourceType</th>
      <th>id</th>
      <th>meta</th>
      <th>implicitRules</th>
      <th>text</th>
      <th>contained</th>
      <th>extension</th>
      <th>modifierExtension</th>
      <th>identifier</th>
      <th>basedOn</th>
      <th>...</th>
      <th>context</th>
      <th>effectiveDateTime</th>
      <th>effectivePeriod</th>
      <th>dateAsserted</th>
      <th>informationSource</th>
      <th>derivedFrom</th>
      <th>reasonCode</th>
      <th>reasonReference</th>
      <th>note</th>
      <th>dosage</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>MedicationStatement</td>
      <td>2087020</td>
      <td>{'lastUpdated': '2021-05-11T12:51:16.534+00:00...</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>{'system': 'https://kpininja.com/identifier', ...</td>
      <td>{'reference': 'MedicationRequest/2087020'}</td>
      <td>...</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>{'reference': 'Practitioner/2087019'}</td>
      <td>{'reference': 'MedicationRequest/2087020'}</td>
      <td>None</td>
      <td>None</td>
      <td>{'text': 'Created by py transform'}</td>
      <td>None</td>
    </tr>
    <tr>
      <th>1</th>
      <td>MedicationStatement</td>
      <td>2040745</td>
      <td>{'lastUpdated': '2021-05-10T11:56:56.228+00:00...</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>{'system': 'https://kpininja.com/identifier', ...</td>
      <td>None</td>
      <td>...</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>{'reference': 'MedicationDispense/2040745'}</td>
      <td>None</td>
      <td>None</td>
      <td>{'text': 'Created by py transform'}</td>
      <td>None</td>
    </tr>
    <tr>
      <th>2</th>
      <td>MedicationStatement</td>
      <td>2086901</td>
      <td>{'lastUpdated': '2021-05-18T17:03:24.627+00:00...</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>{'system': 'https://kpininja.com/identifier', ...</td>
      <td>None</td>
      <td>...</td>
      <td>None</td>
      <td>2016-12-05T00:00:00+00:00</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>{'reference': 'MedicationAdministration/2086901'}</td>
      <td>None</td>
      <td>None</td>
      <td>{'text': 'Created by py transform'}</td>
      <td>{'route': {'coding': [{'display': 'INH', 'syst...</td>
    </tr>
    <tr>
      <th>3</th>
      <td>MedicationStatement</td>
      <td>2086902</td>
      <td>{'lastUpdated': '2021-05-12T05:13:47.341+00:00...</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>{'system': 'https://kpininja.com/identifier', ...</td>
      <td>None</td>
      <td>...</td>
      <td>None</td>
      <td>2016-12-05T00:00:00+00:00</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>{'patientInstruction': '                    tw...</td>
    </tr>
  </tbody>
</table>
<p>4 rows  27 columns</p>
</div>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

</div>
 

